<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Web Resource</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <script>
//run a function that gets the User GUID and checks if the ramcosub_loggedin is false
window.onload = function() {
    setRoundRobinLogin();
}
function setRoundRobinLogin()
{
    var loginStatus = getLoginStatusForUser();
    var userId = window.parent.Xrm.Page.context.getUserId();
    userId = userId.slice(1,userId.length -1);
    if (loginStatus === false)
    {
        var listOfTeams = getListOfTeams(userId);
        createActiveLoginRecordWithinBusinesHours(listOfTeams, userId);
        updateUserRamcosub_loggedin(userId);
    }
}


function getLoginStatusForUser()
{
    var req = new XMLHttpRequest();
    var userId = window.parent.Xrm.Page.context.getUserId();
    req.open("GET", window.parent.Xrm.Page.context.getClientUrl() + "/api/data/v8.2/systemusers(" + userId.slice(1,userId.length -1) + ")?$select=ramcosub_loggedin", false);
    req.setRequestHeader("OData-MaxVersion", "4.0");
    req.setRequestHeader("OData-Version", "4.0");
    req.setRequestHeader("Accept", "application/json");
    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
    req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
    req.send();
    if (req.readyState === 4 && req.status === 200) {
        var result = JSON.parse(req.response);
        return result["ramcosub_loggedin"];
    }
    else {
        window.parent.Xrm.Utility.alertDialog(req.statusText);
    }
    
};

function createLoginRecord(userId, teamId)
{
    var entity = {};
    entity.ramcosub_Team = {
        Id: teamId,
        LogicalName: "team"
    };
    entity.ramcosub_User = {
        Id: userId,
        LogicalName: "systemuser"
    };
    entity.ramcosub_name = "User Logged In";

    var req = new XMLHttpRequest();
    req.open("POST", encodeURI(window.parent.Xrm.Page.context.getClientUrl() + "/XRMServices/2011/OrganizationData.svc/ramcosub_userloginSet"), true);
    req.setRequestHeader("Accept", "application/json");
    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
    req.send(JSON.stringify(entity));
}

function updateUserRamcosub_loggedin(userId)
{
    var entity = {};
    entity.ramcosub_LoggedIn = true;

    var req = new XMLHttpRequest();
    req.open("POST", window.parent.Xrm.Page.context.getClientUrl() + "/XRMServices/2011/OrganizationData.svc/SystemUserSet(guid'(" + userId + ")')", false);
    req.setRequestHeader("Accept", "application/json");
    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
    req.setRequestHeader("X-HTTP-Method", "MERGE");
    req.send(JSON.stringify(entity));
}

function parseTimeStringToTime(timeString) {
    var dummyDate = new Date('1970-01-01T' + timeString);
  
    var hours = dummyDate.getHours();
    var minutes = dummyDate.getMinutes();
    var seconds = dummyDate.getSeconds();

    var time = {
      hours: hours,
      minutes: minutes,
      seconds: seconds
    };
  
    return time;
  }

function createActiveLoginRecordWithinBusinesHours(listOfTeams, userId)
{
    // For each team, Get the Open and Closed Hours Of Operation String from each team, convert it to Time objects and compare it to the time the event happened
    for (i = 0; i < listOfTeams.length; i++)
    {
        teamId = listOfTeams[i][2];
        execution = new Date().getTime();
        openTimeParse = parseTimeStringToTime(listOfTeams[i][0]);
        openTime = new Date();
        openTime.setMinutes(openTimeParse.minutes);
        openTime.setHours(openTimeParse.hours);
        closeTimeParse = parseTimeStringToTime(listOfTeams[i][1]);
        closeTime = new Date();
        closeTime.setMinutes(closeTimeParse.minutes);
        closeTime.setHours(closeTimeParse.hours);
        console.log("is execution > openTime?");
        console.log(execution > openTime.getTime());
        console.log("is execution > closeTime?");
        console.log(execution < closeTime.getTime());
        if (execution > openTime.getTime() && execution < closeTime.getTime())
        {
            // If the event is within the hours, create a User Login record and set the Lookup field to the Team record.
            createLoginRecord(userId, teamId);
        }  
    }
}

function parseTimeStringToTime(timeString) {
    var [time, period] = timeString.split(' ');
    var [hours, minutes] = time.split(':').map(Number);
  
    if (period.toLowerCase() === 'pm' && hours !== 12) {
      hours += 12;
    } else if (period.toLowerCase() === 'am' && hours === 12) {
      hours = 0;
    }

    var time = {
        hours: hours,
        minutes: minutes
    };
    return time;
}

function getListOfTeams(userId) {
    var listOfTeams = [];

    var req = new XMLHttpRequest();
    req.open("GET", window.parent.Xrm.Page.context.getClientUrl() + "/api/data/v8.2/systemusers(" + userId + ")?$expand=teammembership_association($select=teamid,name,ramcosub_hoursofoperationclosed,ramcosub_hoursofoperationopen)", false);
    req.setRequestHeader("OData-MaxVersion", "4.0");
    req.setRequestHeader("OData-Version", "4.0");
    req.setRequestHeader("Accept", "application/json");
    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
    req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
    req.send();
    if (req.readyState === 4 && req.status === 200) {
        var results = JSON.parse(req.response);
        for (var i = 0; i < results["teammembership_association"].length; i++) {
            var openTime = results["teammembership_association"][i]["ramcosub_hoursofoperationopen"];
            var closeTime = results["teammembership_association"][i]["ramcosub_hoursofoperationclosed"];
            var teamId = results["teammembership_association"][i]["teamid"];
            if (openTime !== null && closeTime !== null)
            {
                listOfTeams.push([openTime, closeTime, teamId]);
            }
            else
            {
                continue
            }
        }
    } else 
    {
        window.parent.Xrm.Utility.alertDialog(req.statusText);
    }
    return listOfTeams;
}
    </script>
</body>
</html>
